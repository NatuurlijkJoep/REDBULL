<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Red Bull Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, sans-serif; }
    body { background: linear-gradient(135deg, #1e3a8a, #1e40af, #dc2626); min-height: 100vh; padding: 0.5rem; }
    .container { max-width: 80rem; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 1.5rem; }
    .header-box { display: inline-block; background: #dc2626; padding: 1rem 2rem; border-radius: 1.5rem; box-shadow: 0 20px 25px rgba(0,0,0,0.3); transform: rotate(-1deg); }
    h1 { font-size: 2.5rem; font-weight: 900; color: #fcd34d; text-shadow: 2px 2px 0px rgba(0,0,0,0.3); }
    .tabs { display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .tab { background: white; color: #1e3a8a; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: bold; cursor: pointer; border: none; font-size: 1rem; }
    .tab.active { background: #fcd34d; transform: scale(1.05); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
    .card { background: white; padding: 1.5rem; border-radius: 1rem; margin-bottom: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: 4px solid #fbbf24; }
    .yellow-card { background: #fcd34d; border: 4px solid #1e3a8a; }
    input, select { width: 100%; padding: 0.75rem; margin: 0.75rem 0; border: 2px solid #1e3a8a; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; }
    input:focus, select:focus { outline: none; border-color: #dc2626; }
    .btn { background: #dc2626; color: #fcd34d; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-size: 1.125rem; font-weight: 900; cursor: pointer; width: 100%; margin-top: 0.5rem; }
    .btn:hover { background: #b91c1c; transform: scale(1.05); }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .stat { background: #fcd34d; padding: 1rem; border-radius: 0.75rem; text-align: center; border: 4px solid #dc2626; }
    .stat-num { font-size: 2.5rem; font-weight: 900; color: #1e3a8a; }
    .stat-label { font-size: 0.75rem; font-weight: bold; color: #dc2626; margin-top: 0.25rem; }
    .hidden { display: none; }
    .entry-item { background: #fef3c7; padding: 0.75rem; border-radius: 0.5rem; border: 2px solid #1e3a8a; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 0.5rem; }
    .delete-btn { background: #dc2626; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: bold; font-size: 0.875rem; }
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; }
    .filter-btns { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .filter-btn { background: #fcd34d; color: #1e3a8a; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: bold; cursor: pointer; border: none; font-size: 0.875rem; }
    .filter-btn.active { background: #dc2626; color: #fcd34d; }
    .edit-mode { background: #e0f2fe !important; }
    .chart-container { position: relative; height: 300px; margin-top: 1rem; }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; }
    @media (max-width: 768px) { h1 { font-size: 1.5rem; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-box">
        <h1>RED BULL TRACKER</h1>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="App.switchTab('dashboard')">üìä Dashboard</button>
      <button class="tab" onclick="App.switchTab('compare')">üë• Compare</button>
      <button class="tab" onclick="App.switchTab('recaps')">üìÖ Recaps</button>
      <button class="tab" onclick="App.switchTab('settings')">‚öôÔ∏è Settings</button>
    </div>

    <div id="tab-dashboard">
      <div class="card">
        <h2 style="color: #dc2626; margin-bottom: 1rem;">Log a Red Bull</h2>
        <form onsubmit="App.addEntry(event); return false;">
          <input type="text" id="person" placeholder="Your name" required>
          <select id="flavor"></select>
          <input type="date" id="date" required>
          <div id="time-input" class="hidden"><input type="time" id="time"></div>
          <div id="cost-input" class="hidden"><input type="number" id="cost" step="0.1" placeholder="Cost (‚Ç¨)"></div>
          <button type="submit" class="btn">ADD</button>
        </form>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="stat-num" id="total-count">0</div>
          <div class="stat-label">TOTAL</div>
        </div>
        <div class="stat" style="border-color: #1e3a8a;">
          <div class="stat-num" id="total-caffeine">0mg</div>
          <div class="stat-label">CAFFEINE</div>
        </div>
        <div class="stat" id="cost-stat" class="hidden">
          <div class="stat-num" id="total-cost">‚Ç¨0.00</div>
          <div class="stat-label">SPENT</div>
        </div>
        <div class="stat" style="border-color: #1e3a8a;">
          <div class="stat-num" id="leader">N/A</div>
          <div class="stat-label">LEADER</div>
        </div>
      </div>

      <div class="card">
        <div class="chart-header">
          <h3 style="color: #dc2626; font-weight: bold;">üìà Consumption Timeline</h3>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <div class="filter-btns" id="timeline-view-filters"></div>
            <div class="filter-btns" id="timeline-filters"></div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="timeline-chart"></canvas>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <h3 style="color: #dc2626; margin-bottom: 1rem; font-weight: bold;">üî• Current Streaks</h3>
          <div id="streaks-list"></div>
        </div>

        <div class="card">
          <h3 style="color: #1e3a8a; margin-bottom: 1rem; font-weight: bold;">üìà Period Comparison</h3>
          <div id="comparison-list"></div>
        </div>
      </div>

      <div class="card">
        <div class="chart-header">
          <h3 style="color: #1e3a8a; font-weight: bold;">üìÖ Day of Week Pattern</h3>
          <div class="filter-btns" id="day-filters"></div>
        </div>
        <div class="chart-container">
          <canvas id="day-chart"></canvas>
        </div>
      </div>

      <div class="card" id="time-card" class="hidden">
        <div class="chart-header">
          <h3 style="color: #dc2626; font-weight: bold;">üïê Time of Day Pattern</h3>
          <div class="filter-btns" id="time-filters"></div>
        </div>
        <div class="chart-container">
          <canvas id="time-chart"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="chart-header">
          <h3 style="color: #1e3a8a; font-weight: bold;">üçπ Favorite Flavors</h3>
          <div class="filter-btns" id="flavor-filters"></div>
        </div>
        <div class="chart-container">
          <canvas id="flavor-chart"></canvas>
        </div>
      </div>

      <div class="card">
        <h3 style="color: #1e3a8a; margin-bottom: 1rem; font-weight: bold;">Recent Entries</h3>
        <div id="entries-list"></div>
      </div>
    </div>

    <div id="tab-compare" class="hidden"></div>
    <div id="tab-recaps" class="hidden"></div>
    
    <div id="tab-settings" class="hidden">
      <div class="card">
        <h2 style="color: #dc2626; margin-bottom: 1rem;">Tracking Options</h2>
        <label style="display: flex; gap: 0.75rem; align-items: center; margin: 1rem 0; cursor: pointer;">
          <input type="checkbox" id="track-time" onchange="App.updateSettings()" style="width: auto;">
          <span style="font-weight: bold; color: #1e3a8a;">Track time of day</span>
        </label>
        <label style="display: flex; gap: 0.75rem; align-items: center; margin: 1rem 0; cursor: pointer;">
          <input type="checkbox" id="track-cost" onchange="App.updateSettings()" style="width: auto;">
          <span style="font-weight: bold; color: #1e3a8a;">Track cost</span>
        </label>
        <div id="default-cost-input" class="hidden" style="margin-top: 1rem;">
          <label style="font-weight: bold; color: #1e3a8a; display: block; margin-bottom: 0.5rem;">Default cost per can (‚Ç¨)</label>
          <input type="number" id="default-cost" step="0.1" value="2.5" onchange="App.updateSettings()" style="width: 200px;">
        </div>
      </div>

      <div class="card yellow-card">
        <h2 style="color: #1e3a8a; font-weight: bold; margin-bottom: 1rem;">Manage Flavors</h2>
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
          <input type="text" id="new-flavor" placeholder="New flavor name" style="flex: 1;">
          <button onclick="App.addFlavor()" style="background: #dc2626; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-weight: bold; cursor: pointer;">Add</button>
        </div>
        <div id="flavors-list" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
      </div>
    </div>
  </div>

  <script>
    const App = (function() {
      const SUPABASE_URL = 'https://usnqyxrjswoampjwlhla.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzbnF5eHJqc3dvYW1wandsaGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDE4ODMsImV4cCI6MjA4MzM3Nzg4M30.MU1Geo6OVQTOuNxwWjBWu3iPyp7DkY2OlLn5dfiAvpc';
      
      let supabase;
      let entries = [];
      let flavors = ['Original', 'Sugar Free', 'Tropical', 'Watermelon', 'Coconut Berry', 'Red Edition', 'Blue Edition', 'Yellow Edition', 'Other'];
      let settings = { trackTime: false, trackCost: false, defaultCost: 2.5 };
      let selectedPerson = null;
      let timelineView = 'last30';
      let editingId = null;
      let charts = {};

      async function init() {
        console.log('Initializing...');
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        document.getElementById('time').value = new Date().toTimeString().slice(0, 5);
        document.getElementById('cost').value = settings.defaultCost;
        
        await loadData();
        render();
        subscribe();
      }

      async function loadData() {
        try {
          const { data } = await supabase.from('entries').select('*').order('date', { ascending: false });
          if (data) entries = data;
          
          const { data: f } = await supabase.from('settings').select('*').eq('key', 'flavors').single();
          if (f?.value) flavors = f.value;
          
          const { data: p } = await supabase.from('settings').select('*').eq('key', 'preferences').single();
          if (p?.value) {
            settings = p.value;
            document.getElementById('track-time').checked = settings.trackTime;
            document.getElementById('track-cost').checked = settings.trackCost;
            document.getElementById('default-cost').value = settings.defaultCost;
            updateSettings();
          }
        } catch (err) {
          console.error('Load error:', err);
        }
      }

      function subscribe() {
        supabase.channel('changes').on('postgres_changes', { event: '*', schema: 'public', table: 'entries' }, async () => {
          await loadData();
          render();
        }).subscribe();
      }

      function switchTab(tab) {
        document.querySelectorAll('.tab').forEach((btn, i) => {
          btn.classList.toggle('active', ['dashboard', 'compare', 'recaps', 'settings'][i] === tab);
        });
        
        ['dashboard', 'compare', 'recaps', 'settings'].forEach(t => {
          document.getElementById(`tab-${t}`).classList.toggle('hidden', t !== tab);
        });
        
        if (tab === 'compare') renderCompare();
        if (tab === 'recaps') renderRecaps();
      }

      async function addEntry(e) {
        e.preventDefault();
        const person = document.getElementById('person').value.trim();
        if (!person) return alert('Enter your name!');
        
        const name = person.charAt(0).toUpperCase() + person.slice(1).toLowerCase();
        
        try {
          const { error } = await supabase.from('entries').insert([{
            person: name,
            flavor: document.getElementById('flavor').value,
            date: document.getElementById('date').value,
            time: settings.trackTime ? document.getElementById('time').value : null,
            cost: settings.trackCost ? parseFloat(document.getElementById('cost').value) : null
          }]);
          
          if (error) {
            console.error('Insert error:', error);
            alert('Failed: ' + error.message);
            return;
          }
          
          document.getElementById('person').value = name;
          await loadData();
          render();
        } catch (err) {
          console.error('Add entry error:', err);
          alert('Error: ' + err.message);
        }
      }

      async function deleteEntry(id) {
        await supabase.from('entries').delete().eq('id', id);
        await loadData();
        render();
      }

      async function editEntry(id) {
        editingId = id;
        render();
      }

      async function saveEdit(id) {
        const person = document.getElementById(`edit-person-${id}`).value.trim();
        const flavor = document.getElementById(`edit-flavor-${id}`).value;
        const date = document.getElementById(`edit-date-${id}`).value;
        const time = document.getElementById(`edit-time-${id}`)?.value;
        const cost = document.getElementById(`edit-cost-${id}`)?.value;

        const name = person.charAt(0).toUpperCase() + person.slice(1).toLowerCase();

        await supabase.from('entries').update({
          person: name,
          flavor,
          date,
          time: settings.trackTime ? time : null,
          cost: settings.trackCost && cost ? parseFloat(cost) : null
        }).eq('id', id);

        editingId = null;
        await loadData();
        render();
      }

      function cancelEdit() {
        editingId = null;
        render();
      }

      async function updateSettings() {
        settings.trackTime = document.getElementById('track-time').checked;
        settings.trackCost = document.getElementById('track-cost').checked;
        settings.defaultCost = parseFloat(document.getElementById('default-cost').value);
        
        document.getElementById('time-input').classList.toggle('hidden', !settings.trackTime);
        document.getElementById('cost-input').classList.toggle('hidden', !settings.trackCost);
        document.getElementById('default-cost-input').classList.toggle('hidden', !settings.trackCost);
        
        if (settings.trackTime) document.getElementById('time').value = new Date().toTimeString().slice(0, 5);
        if (settings.trackCost) document.getElementById('cost').value = settings.defaultCost;
        
        await supabase.from('settings').upsert({ key: 'preferences', value: settings });
        render();
      }

      async function addFlavor() {
        const f = document.getElementById('new-flavor').value.trim();
        if (!f || flavors.includes(f)) return alert('Invalid or duplicate!');
        flavors.push(f);
        await supabase.from('settings').upsert({ key: 'flavors', value: flavors });
        document.getElementById('new-flavor').value = '';
        render();
      }

      async function deleteFlavor(f) {
        if (flavors.length <= 1) return;
        if (entries.some(e => e.flavor === f) && !confirm(`Delete "${f}"?`)) return;
        flavors = flavors.filter(x => x !== f);
        await supabase.from('settings').upsert({ key: 'flavors', value: flavors });
        render();
      }

      function render() {
        renderFlavors();
        renderStats();
        renderStreaks();
        renderComparison();
        renderTimelineChart();
        renderDayChart();
        renderTimeChart();
        renderFlavorChart();
        renderEntries();
        renderFlavorsList();
      }

      function renderFlavors() {
        document.getElementById('flavor').innerHTML = flavors.map(f => `<option value="${f}">${f}</option>`).join('');
      }

      function renderStats() {
        const people = {};
        entries.forEach(e => people[e.person] = (people[e.person] || 0) + 1);
        const leader = Object.keys(people).sort((a, b) => people[b] - people[a])[0] || 'N/A';
        
        document.getElementById('total-count').textContent = entries.length;
        document.getElementById('total-caffeine').textContent = (entries.length * 80) + 'mg';
        document.getElementById('leader').textContent = leader;
        
        if (settings.trackCost) {
          const cost = entries.reduce((s, e) => s + (parseFloat(e.cost) || 0), 0);
          document.getElementById('total-cost').textContent = '‚Ç¨' + cost.toFixed(2);
          document.getElementById('cost-stat').classList.remove('hidden');
        } else {
          document.getElementById('cost-stat').classList.add('hidden');
        }
      }

      function renderEntries() {
        const html = entries.slice(0, 20).map(e => {
          if (editingId === e.id) {
            return `
              <div class="entry-item edit-mode">
                <div style="display: grid; gap: 0.5rem; flex: 1;">
                  <input type="text" id="edit-person-${e.id}" value="${e.person}" style="margin: 0; padding: 0.5rem;">
                  <select id="edit-flavor-${e.id}" style="margin: 0; padding: 0.5rem;">
                    ${flavors.map(f => `<option value="${f}" ${f === e.flavor ? 'selected' : ''}>${f}</option>`).join('')}
                  </select>
                  <input type="date" id="edit-date-${e.id}" value="${e.date}" style="margin: 0; padding: 0.5rem;">
                  ${settings.trackTime ? `<input type="time" id="edit-time-${e.id}" value="${e.time || ''}" style="margin: 0; padding: 0.5rem;">` : ''}
                  ${settings.trackCost ? `<input type="number" id="edit-cost-${e.id}" value="${e.cost || ''}" step="0.1" style="margin: 0; padding: 0.5rem;">` : ''}
                </div>
                <div style="display: flex; gap: 0.5rem;">
                  <button onclick="App.saveEdit(${e.id})" style="background: #16a34a; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: bold;">Save</button>
                  <button onclick="App.cancelEdit()" style="background: #6b7280; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: bold;">Cancel</button>
                </div>
              </div>
            `;
          }
          
          return `
            <div class="entry-item">
              <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                <strong style="color: #1e3a8a;">${e.person}</strong>
                <span style="color: #dc2626;">${e.flavor}</span>
                <span style="color: #666; font-size: 0.875rem;">${e.date}</span>
                ${e.time ? `<span style="color: #666; font-size: 0.875rem;">${e.time}</span>` : ''}
                ${e.cost ? `<span style="color: #16a34a; font-size: 0.875rem;">‚Ç¨${e.cost}</span>` : ''}
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button onclick="App.editEntry(${e.id})" style="background: #3b82f6; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: bold; font-size: 0.875rem;">Edit</button>
                <button class="delete-btn" onclick="App.deleteEntry(${e.id})">Delete</button>
              </div>
            </div>
          `;
        }).join('');
        document.getElementById('entries-list').innerHTML = html || '<p style="text-align: center; padding: 1rem; color: #666;">No entries yet</p>';
      }

      function renderStreaks() {
        const people = [...new Set(entries.map(e => e.person))];
        const html = people.map(p => {
          const userEntries = entries.filter(e => e.person === p).sort((a, b) => new Date(b.date) - new Date(a.date));
          let streak = 0;
          if (userEntries.length) {
            streak = 1;
            for (let i = 0; i < userEntries.length - 1; i++) {
              const diffDays = Math.floor((new Date(userEntries[i].date) - new Date(userEntries[i+1].date)) / (1000*60*60*24));
              if (diffDays === 1) streak++;
              else break;
            }
          }
          return `
            <div style="background: #fef3c7; padding: 0.75rem; border-radius: 0.5rem; border: 2px solid #1e3a8a; display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
              <span style="font-weight: bold; color: #1e3a8a;">${p}</span>
              <span style="font-size: 1.5rem; font-weight: 900; color: #f97316;">${streak} day${streak !== 1 ? 's' : ''}</span>
            </div>
          `;
        }).join('');
        document.getElementById('streaks-list').innerHTML = html || '<p style="text-align: center; color: #666;">No data</p>';
      }

      function renderComparison() {
        const now = new Date();
        const thisWeekStart = new Date(now.setDate(now.getDate() - now.getDay()));
        const lastWeekStart = new Date(thisWeekStart);
        lastWeekStart.setDate(lastWeekStart.getDate() - 7);
        
        const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);

        const thisWeek = entries.filter(e => new Date(e.date) >= thisWeekStart).length;
        const lastWeek = entries.filter(e => { const d = new Date(e.date); return d >= lastWeekStart && d < thisWeekStart; }).length;
        const thisMonth = entries.filter(e => new Date(e.date) >= thisMonthStart).length;
        const lastMonth = entries.filter(e => { const d = new Date(e.date); return d >= lastMonthStart && d < thisMonthStart; }).length;

        document.getElementById('comparison-list').innerHTML = `
          <div style="background: #fef3c7; padding: 0.75rem; border-radius: 0.5rem; border: 2px solid #1e3a8a; margin-bottom: 0.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: bold; color: #1e3a8a;">This Week</div>
                <div style="font-size: 0.875rem; color: #666;">Last Week: ${lastWeek}</div>
              </div>
              <span style="font-size: 1.5rem; font-weight: 900; color: #dc2626;">${thisWeek}</span>
            </div>
          </div>
          <div style="background: #fef3c7; padding: 0.75rem; border-radius: 0.5rem; border: 2px solid #1e3a8a;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: bold; color: #1e3a8a;">This Month</div>
                <div style="font-size: 0.875rem; color: #666;">Last Month: ${lastMonth}</div>
              </div>
              <span style="font-size: 1.5rem; font-weight: 900; color: #dc2626;">${thisMonth}</span>
            </div>
          </div>
        `;
      }

      function renderTimelineChart() {
        const people = [...new Set(entries.map(e => e.person))];
        
        // View filter buttons (Last 30 Days / 2026)
        const viewFiltersHtml = `
          <button class="filter-btn ${timelineView === 'last30' ? 'active' : ''}" onclick="App.setTimelineView('last30')">Last 30 Days</button>
          <button class="filter-btn ${timelineView === '2026' ? 'active' : ''}" onclick="App.setTimelineView('2026')">2026</button>
        `;
        document.getElementById('timeline-view-filters').innerHTML = viewFiltersHtml;
        
        // Person filter buttons
        const filtersHtml = `
          <button class="filter-btn ${selectedPerson === null ? 'active' : ''}" onclick="App.setFilter(null, 'timeline')">All Combined</button>
          ${people.map(p => `<button class="filter-btn ${selectedPerson === p ? 'active' : ''}" onclick="App.setFilter('${p}', 'timeline')">${p}</button>`).join('')}
        `;
        document.getElementById('timeline-filters').innerHTML = filtersHtml;

        let dates = [];
        let labels = [];
        
        if (timelineView === 'last30') {
          // Last 30 days view
          for (let i = 29; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            dates.push(d.toISOString().split('T')[0]);
          }
          labels = dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        } else {
          // 2026 view - from Jan 1 to today (or end of year if past)
          const today = new Date();
          const startDate = new Date('2026-01-01');
          const endDate = today.getFullYear() === 2026 ? today : new Date('2026-12-31');
          
          const currentDate = new Date(startDate);
          while (currentDate <= endDate) {
            dates.push(currentDate.toISOString().split('T')[0]);
            currentDate.setDate(currentDate.getDate() + 1);
          }
          
          // Label every 7th day for cleaner display
          labels = dates.map((d, i) => {
            if (i % 7 === 0 || i === dates.length - 1) {
              return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            return '';
          });
        }

        const filtered = selectedPerson ? entries.filter(e => e.person === selectedPerson) : entries;
        const counts = {};
        dates.forEach(d => counts[d] = 0);
        filtered.forEach(e => {
          if (counts[e.date] !== undefined) counts[e.date]++;
        });

        if (charts.timeline) charts.timeline.destroy();
        const ctx = document.getElementById('timeline-chart').getContext('2d');
        charts.timeline = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: selectedPerson || 'Total',
              data: Object.values(counts),
              borderColor: '#dc2626',
              backgroundColor: 'rgba(220, 38, 38, 0.1)',
              tension: 0.4,
              fill: true,
              pointRadius: timelineView === '2026' ? 2 : 3,
              pointHoverRadius: timelineView === '2026' ? 4 : 5
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  title: function(context) {
                    return dates[context[0].dataIndex];
                  }
                }
              }
            },
            scales: {
              y: { 
                beginAtZero: true,
                ticks: { stepSize: 1 }
              },
              x: {
                ticks: {
                  maxRotation: timelineView === '2026' ? 45 : 0,
                  minRotation: timelineView === '2026' ? 45 : 0
                }
              }
            }
          }
        });
      }

      function renderDayChart() {
        const people = [...new Set(entries.map(e => e.person))];
        
        const filtersHtml = `
          <button class="filter-btn ${selectedPerson === null ? 'active' : ''}" onclick="App.setFilter(null, 'day')">All Combined</button>
          ${people.map(p => `<button class="filter-btn ${selectedPerson === p ? 'active' : ''}" onclick="App.setFilter('${p}', 'day')">${p}</button>`).join('')}
        `;
        document.getElementById('day-filters').innerHTML = filtersHtml;

        const filtered = selectedPerson ? entries.filter(e => e.person === selectedPerson) : entries;
        const days = { Monday: 0, Tuesday: 0, Wednesday: 0, Thursday: 0, Friday: 0, Saturday: 0, Sunday: 0 };
        filtered.forEach(e => {
          const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][new Date(e.date).getDay()];
          days[dayName]++;
        });

        if (charts.day) charts.day.destroy();
        const ctx = document.getElementById('day-chart').getContext('2d');
        charts.day = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
            datasets: [{
              label: 'Red Bulls',
              data: Object.values(days),
              backgroundColor: '#dc2626',
              borderColor: '#1e3a8a',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: { 
                beginAtZero: true,
                ticks: { stepSize: 1 }
              }
            }
          }
        });
      }

      function renderTimeChart() {
        if (!settings.trackTime) {
          document.getElementById('time-card').classList.add('hidden');
          return;
        }
        document.getElementById('time-card').classList.remove('hidden');

        const people = [...new Set(entries.map(e => e.person))];
        
        const filtersHtml = `
          <button class="filter-btn ${selectedPerson === null ? 'active' : ''}" onclick="App.setFilter(null, 'time')">All Combined</button>
          ${people.map(p => `<button class="filter-btn ${selectedPerson === p ? 'active' : ''}" onclick="App.setFilter('${p}', 'time')">${p}</button>`).join('')}
        `;
        document.getElementById('time-filters').innerHTML = filtersHtml;
        
        const filtered = selectedPerson ? entries.filter(e => e.person === selectedPerson) : entries;
        const periods = { Morning: 0, Afternoon: 0, Evening: 0, Night: 0 };
        
        filtered.forEach(e => {
          if (!e.time) return;
          const hour = parseInt(e.time.split(':')[0]);
          if (hour >= 5 && hour < 12) periods.Morning++;
          else if (hour >= 12 && hour < 17) periods.Afternoon++;
          else if (hour >= 17 && hour < 21) periods.Evening++;
          else periods.Night++;
        });

        if (charts.time) charts.time.destroy();
        const ctx = document.getElementById('time-chart').getContext('2d');
        charts.time = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(periods),
            datasets: [{
              data: Object.values(periods),
              backgroundColor: ['#fcd34d', '#dc2626', '#1e3a8a', '#6b7280'],
              borderColor: '#ffffff',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });
      }

      function renderFlavorChart() {
        const people = [...new Set(entries.map(e => e.person))];
        
        const filtersHtml = `
          <button class="filter-btn ${selectedPerson === null ? 'active' : ''}" onclick="App.setFilter(null, 'flavor')">All Combined</button>
          ${people.map(p => `<button class="filter-btn ${selectedPerson === p ? 'active' : ''}" onclick="App.setFilter('${p}', 'flavor')">${p}</button>`).join('')}
        `;
        document.getElementById('flavor-filters').innerHTML = filtersHtml;

        const filtered = selectedPerson ? entries.filter(e => e.person === selectedPerson) : entries;
        const flavorCounts = {};
        filtered.forEach(e => flavorCounts[e.flavor] = (flavorCounts[e.flavor] || 0) + 1);
        const sorted = Object.entries(flavorCounts).sort((a, b) => b[1] - a[1]);

        if (charts.flavor) charts.flavor.destroy();
        const ctx = document.getElementById('flavor-chart').getContext('2d');
        charts.flavor = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: sorted.map(([f]) => f),
            datasets: [{
              label: 'Count',
              data: sorted.map(([, c]) => c),
              backgroundColor: '#fcd34d',
              borderColor: '#1e3a8a',
              borderWidth: 2
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: { 
                beginAtZero: true,
                ticks: { stepSize: 1 }
              }
            }
          }
        });
      }

      function setFilter(person, chart) {
        selectedPerson = person;
        if (chart === 'timeline') renderTimelineChart();
        else if (chart === 'day') renderDayChart();
        else if (chart === 'time') renderTimeChart();
        else if (chart === 'flavor') renderFlavorChart();
      }

      function setTimelineView(view) {
        timelineView = view;
        renderTimelineChart();
      }

      function renderFlavorsList() {
        const html = flavors.map(f => `
          <div style="background: white; padding: 0.5rem 1rem; border-radius: 1rem; border: 2px solid #1e3a8a; display: flex; gap: 0.5rem; align-items: center;">
            <span style="font-weight: 600; color: #1e3a8a;">${f}</span>
            <button onclick="App.deleteFlavor('${f}')" style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 1.25rem;">√ó</button>
          </div>
        `).join('');
        document.getElementById('flavors-list').innerHTML = html;
      }

      function renderCompare() {
        const people = [...new Set(entries.map(e => e.person))];
        const html = people.map(p => {
          const ue = entries.filter(e => e.person === p);
          const cost = settings.trackCost ? ue.reduce((s, e) => s + (parseFloat(e.cost) || 0), 0) : 0;
          return `
            <div class="card">
              <h2 style="color: #1e3a8a; font-weight: 900; margin-bottom: 1rem;">${p}</h2>
              <div class="stats">
                <div class="stat"><div class="stat-num">${ue.length}</div><div class="stat-label">Total</div></div>
                <div class="stat" style="border-color: #1e3a8a;"><div class="stat-num">${ue.length * 80}mg</div><div class="stat-label">Caffeine</div></div>
                ${settings.trackCost ? `<div class="stat"><div class="stat-num">‚Ç¨${cost.toFixed(2)}</div><div class="stat-label">Spent</div></div>` : ''}
              </div>
            </div>
          `;
        }).join('');
        document.getElementById('tab-compare').innerHTML = html || '<div class="card"><p style="text-align: center; color: #666;">No data</p></div>';
      }

      function renderRecaps() {
        const recap = {};
        entries.forEach(e => {
          const d = new Date(e.date);
          const m = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
          const y = `${d.getFullYear()}`;
          if (!recap[m]) recap[m] = { type: 'month', count: 0, caffeine: 0, cost: 0 };
          if (!recap[y]) recap[y] = { type: 'year', count: 0, caffeine: 0, cost: 0 };
          recap[m].count++; recap[m].caffeine += 80; recap[m].cost += parseFloat(e.cost) || 0;
          recap[y].count++; recap[y].caffeine += 80; recap[y].cost += parseFloat(e.cost) || 0;
        });
        
        const html = Object.entries(recap).sort((a, b) => b[0].localeCompare(a[0])).map(([p, d]) => {
          const label = d.type === 'year' ? `Year ${p}` : new Date(p + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
          return `
            <div style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem; border: 2px solid #1e3a8a; margin-bottom: 1rem;">
              <h3 style="color: #1e3a8a; font-weight: bold; margin-bottom: 0.5rem;">${label}</h3>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                <div><div style="font-size: 1.5rem; font-weight: 900; color: #dc2626;">${d.count}</div><div style="font-size: 0.875rem; color: #666;">Red Bulls</div></div>
                <div><div style="font-size: 1.5rem; font-weight: 900; color: #1e3a8a;">${d.caffeine}mg</div><div style="font-size: 0.875rem; color: #666;">Caffeine</div></div>
                ${settings.trackCost ? `<div><div style="font-size: 1.5rem; font-weight: 900; color: #16a34a;">‚Ç¨${d.cost.toFixed(2)}</div><div style="font-size: 0.875rem; color: #666;">Cost</div></div>` : ''}
              </div>
            </div>
          `;
        }).join('');
        document.getElementById('tab-recaps').innerHTML = `<div class="card">${html || '<p style="text-align: center; color: #666;">No data</p>'}</div>`;
      }

      return {
        init,
        switchTab,
        addEntry,
        deleteEntry,
        editEntry,
        saveEdit,
        cancelEdit,
        updateSettings,
        addFlavor,
        deleteFlavor,
        setFilter,
        setTimelineView
      };
    })();

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', App.init);
    } else {
      setTimeout(() => window.supabase && App.init(), 100);
    }
  </script>
</body>
</html>